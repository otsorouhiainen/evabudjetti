generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["reactNative"]
}

datasource db {
  provider = "sqlite"
  url      = "file:./app.db"
}

// Differentiates between money coming in and money going out.
enum TransactionType {
  INCOME
  EXPENSE
}

// A global settings table for the app.
// Contains things like language, theme etc
model AppSettings {
  id        String @id @default(cuid())
  key       String
  value     String
  data_type String

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

// The single, global budget for the entire app. Will only contain one row.
model Budget {
  // We use a fixed ID of 1 so we can always query for the same record.
  id Int @id @default(1)

  // Planned transactions
  plannedTransactions RecurringTransaction[]
}

// Realized transactions
model Spending {
  id Int @id @default(1)

  // Realized transactions
  transactions OneTimeTransaction[]
}

model Category {
  id   String @id @default(cuid())
  name String

  // Each category is either for income or expenses.
  type TransactionType

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // All transactions that use this category.
  recurringTransactions RecurringTransaction[]
  oneTimeTransactions   OneTimeTransaction[]

  @@unique([name])
}

// TEMPLATE for a recurring transaction.
model RecurringTransaction {
  id          String   @id @default(cuid())
  description String
  // Amount in EUR
  amount      Int
  // iCal RRULE string
  rrule       String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // All recurring transactions belong to the single budget.
  budget   Budget @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  budgetId Int    @default(1) // Always links to the Budget with id = 1.

  category   Category @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  categoryId String

  @@index([budgetId])
  @@index([categoryId])
}

// This is used for budgeting dynamic transactions with a certain
// e.g 'I aim to spend 300 on groceries'. But the real amount might differ
model TransactionTarget {
  id		String id @default(cuid())
  description	String
  amount	Int
  rrule		String
  createdAt 	DateTime @default(now())
  updatedAt	DateTime @updatedAt

  budget   Budget @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  budgetId Int    @default(1) // Always links to the Budget with id = 1.

  category   Category @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  categoryId String

  @@index([budgetId])
  @@index([categoryId])
}


// A single, concrete transaction that has occurred.
// Recurring transactions get realized into one time
model OneTimeTransaction {
  id          String   @id @default(cuid())
  description String
  // Amount stored in EUR
  amount      Int
  date        DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // All one-time transactions belong to spending.
  spending   Spending @relation(fields: [spendingId], references: [id], onDelete: Cascade)
  spendingId Int      @default(1) // Always links to the Spending with id = 1.

  category   Category @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  categoryId String

  @@index([spendingId])
  @@index([categoryId])
}
